import{r as a,j as s,G as U,D as H,t as p,o as v,A as I,p as q,q as V,T as J,v as D,u as l}from"./main-Jb7canCu.js";import{D as z}from"./DischargeModal-CY5pOg1z.js";import{B as x}from"./building-2-CG_4tYQe.js";import{C as S}from"./circle-check-big-B7H4gtXW.js";import{C as K}from"./clock-oLN2TNw3.js";import"./arrow-right--UMFdfon.js";import"./check-BUxc0fWz.js";function ae({purchases:h=[],tanks:_=[],currency:f="SDG"}){const[c,y]=a.useState(""),[d,C]=a.useState(""),[i,A]=a.useState(""),[u,F]=a.useState(""),[T,m]=a.useState(!1),[n,g]=a.useState(null),[L,b]=a.useState(!1),[M,j]=a.useState(!1),B=e=>{if(!e)return!1;const t=Math.abs(new Date-new Date(e));return Math.ceil(t/(1e3*60*60*24))>10},O=async()=>{if(!n)return;b(!0);const e=new FormData;e.append("id",n.id);try{const o=await(await fetch(`${window.BASE_URL}/purchases/delete_ajax`,{method:"POST",body:e})).text();let r;try{r=JSON.parse(o)}catch{throw new Error("Invalid Server Response")}r.success?(p.success("تم حذف الفاتورة بنجاح"),setTimeout(()=>window.location.reload(),1e3)):p.error(r.message||"فشل عملية الحذف")}catch{p.error("خطأ في الاتصال بالخادم")}finally{b(!1),m(!1),g(null)}},$=e=>{g(e),m(!0)},P=(Array.isArray(h)?h:[]).filter(e=>{const t=c?e.supplier_name===c:!0,o=d?e.status===d:!0,r=new Date(e.created_at||e.date).setHours(0,0,0,0),w=i?new Date(i).setHours(0,0,0,0):null,N=u?new Date(u).setHours(0,0,0,0):null,G=(!w||r>=w)&&(!N||r<=N);return t&&o&&G}),E=[{header:"رقم الفاتورة",accessor:"invoice_number",className:"font-mono font-bold text-navy-900",render:e=>`#${e.invoice_number}`},{header:"التاريخ",accessor:"created_at",render:e=>e.created_at?new Date(e.created_at).toLocaleDateString("en-GB"):"-"},{header:"المورد",accessor:"supplier_name",render:e=>s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx(x,{className:"w-4 h-4 text-slate-400"}),s.jsx("span",{className:"font-bold text-slate-700",children:e.supplier_name||"غير محدد"})]})},{header:"نوع الوقود",accessor:"fuel_type_name",render:e=>s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx(v,{className:"w-4 h-4 text-blue-500"}),s.jsx("span",{className:"font-bold text-blue-900",children:e.fuel_type_name||"غير محدد"})]})},{header:"الكمية (L)",accessor:"volume_ordered",className:"font-mono",render:e=>Number(e.volume_received||e.volume_ordered||0).toLocaleString()},{header:`الاجمالي (${f})`,accessor:"total_cost",className:"font-mono font-bold text-emerald-600",render:e=>s.jsxs("div",{className:"flex items-center gap-1",children:[s.jsx("span",{children:Number(e.total_cost||0).toLocaleString("en-US",{minimumFractionDigits:2})}),s.jsx("span",{className:"text-xs text-emerald-400",children:f})]})},{header:"الحالة",accessor:"status",render:e=>{const t=(e.status==="ordered"||e.status==="pending")&&B(e.created_at);return e.status==="completed"?s.jsxs("span",{className:"inline-flex items-center gap-1.5 px-3 py-1.5 rounded-full text-xs font-bold bg-green-100 text-green-700 border border-green-200",children:[s.jsx(S,{className:"w-3.5 h-3.5"})," تم التفريغ"]}):s.jsxs("span",{className:`inline-flex items-center gap-1.5 px-3 py-1.5 rounded-full text-xs font-bold border ${t?"bg-red-50 text-red-600 border-red-200 animate-pulse":"bg-orange-100 text-orange-700 border-orange-200"}`,children:[t?s.jsx(I,{className:"w-3.5 h-3.5 animate-bounce"}):s.jsx(q,{className:"w-3.5 h-3.5"}),t?"شاحن (تأخير)":"شاحن"]})}}],k=e=>s.jsxs(s.Fragment,{children:[e.status!=="completed"&&s.jsx("button",{onClick:()=>j(!0),title:"تفريغ الشحنة",className:"p-2 text-emerald-600 hover:bg-emerald-50 rounded-lg transition-colors",children:s.jsx(v,{className:"w-4 h-4"})}),s.jsx("a",{href:`${window.BASE_URL}/purchases/edit?id=${e.id}`,className:"p-2 text-blue-600 hover:bg-blue-50 rounded-lg transition-colors",children:s.jsx(V,{className:"w-4 h-4"})}),s.jsx("button",{onClick:()=>$(e),className:"p-2 text-red-600 hover:bg-red-50 rounded-lg transition-colors",children:s.jsx(J,{className:"w-4 h-4"})})]}),R=s.jsxs("div",{className:"flex gap-2 items-center flex-wrap md:flex-nowrap",children:[s.jsxs(D,{placeholder:"كل الموردين",value:c,onValueChange:y,className:"w-40",children:[s.jsx(l,{value:"Saudi Aramco",icon:x,children:"Saudi Aramco"}),s.jsx(l,{value:"National Fuel Co.",icon:x,children:"National Fuel Co."})]}),s.jsxs(D,{placeholder:"حالة الشحن",value:d,onValueChange:C,className:"w-40",children:[s.jsx(l,{value:"completed",icon:S,children:"تم التفريغ"}),s.jsx(l,{value:"ordered",icon:K,children:"شاحن"})]}),s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx("input",{type:"date",value:i,onChange:e=>A(e.target.value),className:"w-32 p-2 rounded-xl border border-slate-200 text-sm outline-none",placeholder:"From"}),s.jsx("span",{className:"text-slate-400",children:"-"}),s.jsx("input",{type:"date",value:u,onChange:e=>F(e.target.value),className:"w-32 p-2 rounded-xl border border-slate-200 text-sm outline-none",placeholder:"To"})]})]});return s.jsxs("div",{className:"p-6 max-w-[1800px] mx-auto print:p-0 print:max-w-none",children:[s.jsx(U,{title:"فواتير المشتريات",subtitle:"إدارة سجلات شراء الوقود الواردة",data:P,columns:E,actions:k,onAdd:()=>window.location.href=`${window.BASE_URL}/purchases/create`,addButtonLabel:"فاتورة جديدة",searchPlaceholder:"بحث برقم الفاتورة أو المورد...",filters:R,exportName:"purchases"}),s.jsx(H,{isOpen:T,onClose:()=>m(!1),onConfirm:O,title:"تحذير: حذف فاتورة شراء",message:`سيتم حذف فاتورة الشراء رقم ${n==null?void 0:n.invoice_number}. هل أنت متأكد؟`,isDeleting:L}),s.jsx(z,{isOpen:M,onClose:()=>j(!1),tanks:_})]})}export{ae as default};
