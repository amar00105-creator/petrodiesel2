import{j as s,q as D,a2 as S,A as _,D as m,a1 as V,o as q,a0 as H,T as y,t as p,_ as W,r as z,k as J}from"./ui-DtuMUTb1.js";import{r}from"./vendor-BdFMDtQB.js";import{c as K,p as C,v as L,f as u,G as Q,D as X}from"./main-CLVC6oQV.js";import{D as Y}from"./DischargeModal-BNZeNR15.js";function re({purchases:T=[],tanks:$=[],currency:f="SDG"}){const[i,w]=r.useState(""),[a,b]=r.useState(""),[o,h]=r.useState(""),[c,g]=r.useState(""),[B,x]=r.useState(!1),[d,j]=r.useState(null),[M,v]=r.useState(!1),[O,N]=r.useState(!1),A=e=>{if(!e)return!1;const t=Math.abs(new Date-new Date(e));return Math.ceil(t/(1e3*60*60*24))>10},k=(T||[]).map(e=>({...e,supplier:e.supplier_name||"غير محدد",fuel:e.fuel_type_name||"غير محدد",status_label:e.status==="completed"?"تم التفريغ":e.status==="ordered"?"شاحن":e.status,date_formatted:e.created_at?new Date(e.created_at).toLocaleDateString("en-GB"):"-"})),F=()=>{if(!a)return[];const e=new Set;return k.forEach(t=>{a==="supplier"?e.add(t.supplier):a==="status"?e.add(t.status_label):a==="fuel"&&e.add(t.fuel)}),Array.from(e).filter(Boolean).sort()},E=k.filter(e=>{const t=e.invoice_number.toString().includes(i)||e.supplier.toLowerCase().includes(i.toLowerCase());let l=!0;a&&o&&(a==="supplier"?l=e.supplier===o:a==="status"?l=e.status_label===o:a==="fuel"&&(l=e.fuel===o));let n=!0;return c&&(n=new Date(e.created_at||e.date).toISOString().split("T")[0]===c),t&&l&&n}),R=()=>{b(""),h(""),w(""),g("")},P=async()=>{if(!d)return;v(!0);const e=new FormData;e.append("id",d.id);try{const l=await(await fetch(`${window.BASE_URL}/purchases/delete_ajax`,{method:"POST",body:e})).text();let n;try{n=JSON.parse(l)}catch{throw new Error("Invalid Server Response")}n.success?(p.success("تم حذف الفاتورة بنجاح"),setTimeout(()=>window.location.reload(),1e3)):p.error(n.message||"فشل عملية الحذف")}catch{p.error("خطأ في الاتصال بالخادم")}finally{v(!1),x(!1),j(null)}},I=e=>{j(e),x(!0)},U=[{header:"رقم الفاتورة",accessor:"invoice_number",className:"font-mono font-bold text-navy-900",render:e=>`#${e.invoice_number}`},{header:"التاريخ",accessor:"date_formatted"},{header:"المورد",accessor:"supplier",render:e=>s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx(S,{className:"w-4 h-4 text-slate-400"}),s.jsx("span",{className:"font-bold text-slate-700",children:e.supplier})]})},{header:"نوع الوقود",accessor:"fuel",render:e=>s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx(m,{className:"w-4 h-4 text-blue-500"}),s.jsx("span",{className:"font-bold text-blue-900",children:e.fuel})]})},{header:"الكمية (L)",accessor:"volume_ordered",className:"font-mono",render:e=>Number(e.volume_received||e.volume_ordered||0).toLocaleString()},{header:`الاجمالي (${f})`,accessor:"total_cost",className:"font-mono font-bold text-emerald-600",render:e=>s.jsxs("div",{className:"flex items-center gap-1",children:[s.jsx("span",{children:Number(e.total_cost||0).toLocaleString("en-US",{minimumFractionDigits:2})}),s.jsx("span",{className:"text-xs text-emerald-400",children:f})]})},{header:"الحالة",accessor:"status",render:e=>{const t=(e.status==="ordered"||e.status==="pending")&&A(e.created_at);return e.status==="completed"?s.jsxs("span",{className:"inline-flex items-center gap-1.5 px-3 py-1.5 rounded-full text-xs font-bold bg-green-100 text-green-700 border border-green-200",children:[s.jsx(W,{className:"w-3.5 h-3.5"})," تم التفريغ"]}):s.jsxs("span",{className:`inline-flex items-center gap-1.5 px-3 py-1.5 rounded-full text-xs font-bold border ${t?"bg-red-50 text-red-600 border-red-200 animate-pulse":"bg-orange-100 text-orange-700 border-orange-200"}`,children:[t?s.jsx(_,{className:"w-3.5 h-3.5 animate-bounce"}):s.jsx(y,{className:"w-3.5 h-3.5"}),t?"شاحن (تأخير)":"شاحن"]})}}],G=e=>s.jsxs(s.Fragment,{children:[e.status!=="completed"&&s.jsx("button",{onClick:()=>N(!0),title:"تفريغ الشحنة",className:"p-2 text-emerald-600 hover:bg-emerald-50 rounded-lg transition-colors",children:s.jsx(m,{className:"w-4 h-4"})}),s.jsx("a",{href:`${window.BASE_URL}/purchases/edit?id=${e.id}`,className:"p-2 text-blue-600 hover:bg-blue-50 rounded-lg transition-colors",children:s.jsx(z,{className:"w-4 h-4"})}),s.jsx("button",{onClick:()=>I(e),className:"p-2 text-red-600 hover:bg-red-50 rounded-lg transition-colors",children:s.jsx(J,{className:"w-4 h-4"})})]});return s.jsxs("div",{className:"p-6 max-w-[1800px] mx-auto print:p-0 print:max-w-none space-y-6",children:[s.jsx(K,{className:"rounded-2xl shadow-sm ring-1 ring-slate-200 dark:bg-white/5 dark:backdrop-blur-md dark:ring-white/10 dark:shadow-none p-4",children:s.jsxs("div",{className:"flex flex-wrap items-center gap-4",children:[s.jsxs("div",{className:"relative flex-1 min-w-[200px] max-w-[300px]",children:[s.jsx(D,{className:"absolute right-3 top-2.5 text-slate-400 w-4 h-4"}),s.jsx(C,{placeholder:"بحث...",className:"pl-2 pr-9 py-2 text-sm rounded-xl dark:bg-white/5 dark:backdrop-blur-md dark:border-white/10 dark:text-white dark:focus:ring-white/20 dark:focus:border-white/20 w-full transition-all focus:ring-1 focus:ring-blue-100 dark:focus:ring-white/10",value:i,onChange:e=>w(e.target.value)})]}),s.jsx("div",{className:"w-[180px]",children:s.jsxs(L,{placeholder:"نوع الفلترة",value:a,onValueChange:e=>{b(e),h("")},className:"text-sm rounded-xl dark:bg-white/5 dark:backdrop-blur-md dark:border-white/10 dark:text-white min-h-[38px]",children:[s.jsx(u,{value:"supplier",icon:S,className:"text-sm",children:"المورد"}),s.jsx(u,{value:"status",icon:_,className:"text-sm",children:"الحالة"}),s.jsx(u,{value:"fuel",icon:m,className:"text-sm",children:"الوقود"})]})}),s.jsx("div",{className:"w-[180px]",children:s.jsx(L,{placeholder:"القيمة...",value:o,onValueChange:h,disabled:!a,className:"text-sm rounded-xl dark:bg-white/5 dark:backdrop-blur-md dark:border-white/10 dark:text-white disabled:opacity-50 min-h-[38px]",children:F().map((e,t)=>s.jsx(u,{value:e,icon:V,className:"text-sm",children:e},t))})}),s.jsxs("div",{className:"relative w-[160px]",children:[s.jsx(q,{className:"absolute right-3 top-2.5 text-slate-400 w-4 h-4"}),s.jsx(C,{type:"date",value:c,onChange:e=>g(e.target.value),className:"pl-2 pr-9 py-2 text-sm rounded-xl dark:bg-white/5 dark:backdrop-blur-md dark:border-white/10 dark:text-white w-full"})]}),s.jsx("button",{onClick:R,title:"reset",className:"p-2 rounded-xl bg-slate-100 text-slate-600 hover:bg-slate-200 hover:text-red-600 transition-colors dark:bg-white/10 dark:text-slate-300 dark:hover:bg-white/20",children:s.jsx(H,{className:`w-5 h-5 ${a||i||c?"text-red-500":""}`})}),s.jsx("div",{className:"h-8 w-px bg-slate-200 dark:bg-white/10 mx-2"}),s.jsxs("button",{onClick:()=>window.location.href=`${window.BASE_URL}/purchases/create`,className:"flex items-center gap-2 px-4 py-2 bg-navy-900 text-white text-sm font-bold rounded-xl hover:bg-navy-800 transition-colors shadow-sm dark:bg-blue-600 dark:hover:bg-blue-500",children:[s.jsx("div",{className:"bg-white/20 rounded p-0.5",children:s.jsx(y,{className:"w-4 h-4"})}),"فاتورة جديدة"]}),s.jsxs("button",{onClick:()=>window.print(),className:"p-2 text-slate-500 hover:bg-slate-50 rounded-xl dark:text-slate-400 dark:hover:bg-white/5",title:"طباعة",children:[s.jsx(D,{className:"w-5 h-5 hidden"}),s.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",className:"lucide lucide-printer",children:[s.jsx("polyline",{points:"6 9 6 2 18 2 18 9"}),s.jsx("path",{d:"M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"}),s.jsx("rect",{width:"12",height:"8",x:"6",y:"14"})]})]})]})}),s.jsx(Q,{data:E,columns:U,actions:G,onAdd:()=>window.location.href=`${window.BASE_URL}/purchases/create`,addButtonLabel:"فاتورة جديدة",searchPlaceholder:"بحث برقم الفاتورة أو المورد...",hideFilters:!0,searchWrapperClass:"relative w-full md:w-72",actionsInToolbar:!0,hideHeader:!0,exportName:"purchases"}),s.jsx(X,{isOpen:B,onClose:()=>x(!1),onConfirm:P,title:"تحذير: حذف فاتورة شراء",message:`سيتم حذف فاتورة الشراء رقم ${d==null?void 0:d.invoice_number}. هل أنت متأكد؟`,isDeleting:M}),s.jsx(Y,{isOpen:O,onClose:()=>N(!1),tanks:$})]})}export{re as default};
