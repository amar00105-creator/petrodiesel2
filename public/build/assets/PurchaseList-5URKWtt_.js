import{r as a,j as s,t as p,D as N,A as G,T as H,C as I}from"./main-BZye3MWh.js";import{v,f as l}from"./Tracker-B3Wsk5ua.js";import{G as U}from"./GlobalTable-CiHnQ48r.js";import{D as V}from"./DeleteConfirmationModal-CGMvXUfk.js";import{D as q}from"./DischargeModal-BktMOTjs.js";import{B as x}from"./building-2-B4W4HkxD.js";import{C as D}from"./circle-check-big-CfJJ_WJ_.js";import{S as J}from"./square-pen-DTQcLPwn.js";import{T as z}from"./trash-2-D_DkLkqJ.js";import"./download-CUXfZPiX.js";import"./printer-yTjQXX8F.js";import"./plus-CeiUBWS7.js";import"./search-CFPY5UOd.js";import"./chevron-right-DuGftnQt.js";import"./chevron-left-COH1Qeub.js";import"./x-CpP_tiue.js";import"./file-text-DwdbBnTO.js";import"./check-CTS_TuQ9.js";function pe({purchases:h=[],tanks:S=[]}){const[c,_]=a.useState(""),[i,y]=a.useState(""),[d,C]=a.useState(""),[u,A]=a.useState(""),[T,m]=a.useState(!1),[o,f]=a.useState(null),[F,g]=a.useState(!1),[L,b]=a.useState(!1),M=e=>{if(!e)return!1;const t=Math.abs(new Date-new Date(e));return Math.ceil(t/(1e3*60*60*24))>10},B=async()=>{if(!o)return;g(!0);const e=new FormData;e.append("id",o.id);try{const n=await(await fetch(`${window.BASE_URL}/purchases/delete_ajax`,{method:"POST",body:e})).text();let r;try{r=JSON.parse(n)}catch{throw new Error("Invalid Server Response")}r.success?(p.success("تم حذف الفاتورة بنجاح"),setTimeout(()=>window.location.reload(),1e3)):p.error(r.message||"فشل عملية الحذف")}catch{p.error("خطأ في الاتصال بالخادم")}finally{g(!1),m(!1),f(null)}},O=e=>{f(e),m(!0)},P=(Array.isArray(h)?h:[]).filter(e=>{const t=c?e.supplier_name===c:!0,n=i?e.status===i:!0,r=new Date(e.created_at||e.date).setHours(0,0,0,0),w=d?new Date(d).setHours(0,0,0,0):null,j=u?new Date(u).setHours(0,0,0,0):null,k=(!w||r>=w)&&(!j||r<=j);return t&&n&&k}),$=[{header:"رقم الفاتورة",accessor:"invoice_number",className:"font-mono font-bold text-navy-900",render:e=>`#${e.invoice_number}`},{header:"التاريخ",accessor:"created_at",render:e=>e.created_at?new Date(e.created_at).toLocaleDateString("en-GB"):"-"},{header:"المورد",accessor:"supplier_name",render:e=>s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx(x,{className:"w-4 h-4 text-slate-400"}),s.jsx("span",{className:"font-bold text-slate-700",children:e.supplier_name||"غير محدد"})]})},{header:"نوع الوقود",accessor:"fuel_type_name",render:e=>s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx(N,{className:"w-4 h-4 text-blue-500"}),s.jsx("span",{className:"font-bold text-blue-900",children:e.fuel_type_name||"غير محدد"})]})},{header:"الكمية (L)",accessor:"volume_ordered",className:"font-mono",render:e=>Number(e.volume_received||e.volume_ordered||0).toLocaleString()},{header:"الاجمالي (SAR)",accessor:"total_cost",className:"font-mono font-bold text-emerald-600",render:e=>Number(e.total_cost||0).toLocaleString()},{header:"الحالة",accessor:"status",render:e=>{const t=(e.status==="ordered"||e.status==="pending")&&M(e.created_at);return e.status==="completed"?s.jsxs("span",{className:"inline-flex items-center gap-1.5 px-3 py-1.5 rounded-full text-xs font-bold bg-green-100 text-green-700 border border-green-200",children:[s.jsx(D,{className:"w-3.5 h-3.5"})," تم التفريغ"]}):s.jsxs("span",{className:`inline-flex items-center gap-1.5 px-3 py-1.5 rounded-full text-xs font-bold border ${t?"bg-red-50 text-red-600 border-red-200 animate-pulse":"bg-orange-100 text-orange-700 border-orange-200"}`,children:[t?s.jsx(G,{className:"w-3.5 h-3.5 animate-bounce"}):s.jsx(H,{className:"w-3.5 h-3.5"}),t?"شاحن (تأخير)":"شاحن"]})}}],E=e=>s.jsxs(s.Fragment,{children:[e.status!=="completed"&&s.jsx("button",{onClick:()=>b(!0),title:"تفريغ الشحنة",className:"p-2 text-emerald-600 hover:bg-emerald-50 rounded-lg transition-colors",children:s.jsx(N,{className:"w-4 h-4"})}),s.jsx("a",{href:`${window.BASE_URL}/purchases/edit?id=${e.id}`,className:"p-2 text-blue-600 hover:bg-blue-50 rounded-lg transition-colors",children:s.jsx(J,{className:"w-4 h-4"})}),s.jsx("button",{onClick:()=>O(e),className:"p-2 text-red-600 hover:bg-red-50 rounded-lg transition-colors",children:s.jsx(z,{className:"w-4 h-4"})})]}),R=s.jsxs("div",{className:"flex gap-2 items-center flex-wrap md:flex-nowrap",children:[s.jsxs(v,{placeholder:"كل الموردين",value:c,onValueChange:_,className:"w-40",children:[s.jsx(l,{value:"Saudi Aramco",icon:x,children:"Saudi Aramco"}),s.jsx(l,{value:"National Fuel Co.",icon:x,children:"National Fuel Co."})]}),s.jsxs(v,{placeholder:"حالة الشحن",value:i,onValueChange:y,className:"w-40",children:[s.jsx(l,{value:"completed",icon:D,children:"تم التفريغ"}),s.jsx(l,{value:"ordered",icon:I,children:"شاحن"})]}),s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx("input",{type:"date",value:d,onChange:e=>C(e.target.value),className:"w-32 p-2 rounded-xl border border-slate-200 text-sm outline-none",placeholder:"From"}),s.jsx("span",{className:"text-slate-400",children:"-"}),s.jsx("input",{type:"date",value:u,onChange:e=>A(e.target.value),className:"w-32 p-2 rounded-xl border border-slate-200 text-sm outline-none",placeholder:"To"})]})]});return s.jsxs("div",{className:"p-6 max-w-[1800px] mx-auto print:p-0 print:max-w-none",children:[s.jsx(U,{title:"فواتير المشتريات",subtitle:"إدارة سجلات شراء الوقود الواردة",data:P,columns:$,actions:E,onAdd:()=>window.location.href=`${window.BASE_URL}/purchases/create`,addButtonLabel:"فاتورة جديدة",searchPlaceholder:"بحث برقم الفاتورة أو المورد...",filters:R,exportName:"purchases"}),s.jsx(V,{isOpen:T,onClose:()=>m(!1),onConfirm:B,title:"تحذير: حذف فاتورة شراء",message:`سيتم حذف فاتورة الشراء رقم ${o==null?void 0:o.invoice_number}. هل أنت متأكد؟`,isDeleting:F}),s.jsx(q,{isOpen:L,onClose:()=>b(!1),tanks:S})]})}export{pe as default};
