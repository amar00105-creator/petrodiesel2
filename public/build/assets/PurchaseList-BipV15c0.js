import{j as s,t as x,a2 as p,D as v,_ as D,A as U,T as H,r as I,l as V,a3 as q}from"./ui-DpPGrQoH.js";import{r as t}from"./vendor-BdFMDtQB.js";import{G as J,D as z,v as S,f as l}from"./main-i_nKCBsx.js";import{D as K}from"./DischargeModal-BED4_E_U.js";function ee({purchases:h=[],tanks:_=[],currency:f="SDG"}){const[c,y]=t.useState(""),[d,C]=t.useState(""),[i,A]=t.useState(""),[u,F]=t.useState(""),[T,m]=t.useState(!1),[n,g]=t.useState(null),[L,b]=t.useState(!1),[M,j]=t.useState(!1),O=e=>{if(!e)return!1;const a=Math.abs(new Date-new Date(e));return Math.ceil(a/(1e3*60*60*24))>10},$=async()=>{if(!n)return;b(!0);const e=new FormData;e.append("id",n.id);try{const o=await(await fetch(`${window.BASE_URL}/purchases/delete_ajax`,{method:"POST",body:e})).text();let r;try{r=JSON.parse(o)}catch{throw new Error("Invalid Server Response")}r.success?(x.success("تم حذف الفاتورة بنجاح"),setTimeout(()=>window.location.reload(),1e3)):x.error(r.message||"فشل عملية الحذف")}catch{x.error("خطأ في الاتصال بالخادم")}finally{b(!1),m(!1),g(null)}},B=e=>{g(e),m(!0)},P=(Array.isArray(h)?h:[]).filter(e=>{const a=c?e.supplier_name===c:!0,o=d?e.status===d:!0,r=new Date(e.created_at||e.date).setHours(0,0,0,0),w=i?new Date(i).setHours(0,0,0,0):null,N=u?new Date(u).setHours(0,0,0,0):null,G=(!w||r>=w)&&(!N||r<=N);return a&&o&&G}),E=[{header:"رقم الفاتورة",accessor:"invoice_number",className:"font-mono font-bold text-navy-900",render:e=>`#${e.invoice_number}`},{header:"التاريخ",accessor:"created_at",render:e=>e.created_at?new Date(e.created_at).toLocaleDateString("en-GB"):"-"},{header:"المورد",accessor:"supplier_name",render:e=>s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx(p,{className:"w-4 h-4 text-slate-400"}),s.jsx("span",{className:"font-bold text-slate-700",children:e.supplier_name||"غير محدد"})]})},{header:"نوع الوقود",accessor:"fuel_type_name",render:e=>s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx(v,{className:"w-4 h-4 text-blue-500"}),s.jsx("span",{className:"font-bold text-blue-900",children:e.fuel_type_name||"غير محدد"})]})},{header:"الكمية (L)",accessor:"volume_ordered",className:"font-mono",render:e=>Number(e.volume_received||e.volume_ordered||0).toLocaleString()},{header:`الاجمالي (${f})`,accessor:"total_cost",className:"font-mono font-bold text-emerald-600",render:e=>s.jsxs("div",{className:"flex items-center gap-1",children:[s.jsx("span",{children:Number(e.total_cost||0).toLocaleString("en-US",{minimumFractionDigits:2})}),s.jsx("span",{className:"text-xs text-emerald-400",children:f})]})},{header:"الحالة",accessor:"status",render:e=>{const a=(e.status==="ordered"||e.status==="pending")&&O(e.created_at);return e.status==="completed"?s.jsxs("span",{className:"inline-flex items-center gap-1.5 px-3 py-1.5 rounded-full text-xs font-bold bg-green-100 text-green-700 border border-green-200",children:[s.jsx(D,{className:"w-3.5 h-3.5"})," تم التفريغ"]}):s.jsxs("span",{className:`inline-flex items-center gap-1.5 px-3 py-1.5 rounded-full text-xs font-bold border ${a?"bg-red-50 text-red-600 border-red-200 animate-pulse":"bg-orange-100 text-orange-700 border-orange-200"}`,children:[a?s.jsx(U,{className:"w-3.5 h-3.5 animate-bounce"}):s.jsx(H,{className:"w-3.5 h-3.5"}),a?"شاحن (تأخير)":"شاحن"]})}}],k=e=>s.jsxs(s.Fragment,{children:[e.status!=="completed"&&s.jsx("button",{onClick:()=>j(!0),title:"تفريغ الشحنة",className:"p-2 text-emerald-600 hover:bg-emerald-50 rounded-lg transition-colors",children:s.jsx(v,{className:"w-4 h-4"})}),s.jsx("a",{href:`${window.BASE_URL}/purchases/edit?id=${e.id}`,className:"p-2 text-blue-600 hover:bg-blue-50 rounded-lg transition-colors",children:s.jsx(I,{className:"w-4 h-4"})}),s.jsx("button",{onClick:()=>B(e),className:"p-2 text-red-600 hover:bg-red-50 rounded-lg transition-colors",children:s.jsx(V,{className:"w-4 h-4"})})]}),R=s.jsxs("div",{className:"flex gap-2 items-center flex-wrap md:flex-nowrap",children:[s.jsxs(S,{placeholder:"كل الموردين",value:c,onValueChange:y,className:"w-40",children:[s.jsx(l,{value:"Saudi Aramco",icon:p,children:"Saudi Aramco"}),s.jsx(l,{value:"National Fuel Co.",icon:p,children:"National Fuel Co."})]}),s.jsxs(S,{placeholder:"حالة الشحن",value:d,onValueChange:C,className:"w-40",children:[s.jsx(l,{value:"completed",icon:D,children:"تم التفريغ"}),s.jsx(l,{value:"ordered",icon:q,children:"شاحن"})]}),s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx("input",{type:"date",value:i,onChange:e=>A(e.target.value),className:"w-32 p-2 rounded-xl border border-slate-200 text-sm outline-none",placeholder:"From"}),s.jsx("span",{className:"text-slate-400",children:"-"}),s.jsx("input",{type:"date",value:u,onChange:e=>F(e.target.value),className:"w-32 p-2 rounded-xl border border-slate-200 text-sm outline-none",placeholder:"To"})]})]});return s.jsxs("div",{className:"p-6 max-w-[1800px] mx-auto print:p-0 print:max-w-none",children:[s.jsx(J,{title:"فواتير المشتريات",subtitle:"إدارة سجلات شراء الوقود الواردة",data:P,columns:E,actions:k,onAdd:()=>window.location.href=`${window.BASE_URL}/purchases/create`,addButtonLabel:"فاتورة جديدة",searchPlaceholder:"بحث برقم الفاتورة أو المورد...",filters:R,exportName:"purchases"}),s.jsx(z,{isOpen:T,onClose:()=>m(!1),onConfirm:$,title:"تحذير: حذف فاتورة شراء",message:`سيتم حذف فاتورة الشراء رقم ${n==null?void 0:n.invoice_number}. هل أنت متأكد؟`,isDeleting:L}),s.jsx(K,{isOpen:M,onClose:()=>j(!1),tanks:_})]})}export{ee as default};
